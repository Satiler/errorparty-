/**
 * ü§ñ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ú—É–∑—ã–∫–∞–ª—å–Ω–∞—è –°–∏—Å—Ç–µ–º–∞
 * 
 * –ö–æ–º–ø–ª–µ–∫—Å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –¥–ª—è:
 * - –ò–º–ø–æ—Ä—Ç–∞ –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö —Ç—Ä–µ–∫–æ–≤ —Å —Ä–æ—Å—Å–∏–π—Å–∫–∏—Ö –∏ –∑–∞—Ä—É–±–µ–∂–Ω—ã—Ö –ø–ª–æ—â–∞–¥–æ–∫
 * - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–ª–µ–π–ª–∏—Å—Ç–æ–≤
 * - –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –Ω–∞ –æ—Å–Ω–æ–≤–µ –ª–∞–π–∫–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
 * - –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö —á–∞—Ä—Ç–æ–≤
 */

const { Track, Playlist, PlaylistTrack, TrackLike, ListeningHistory, User, Album } = require('../models');
const { Op, fn, col, literal } = require('sequelize');
const { getInstance: getKissVKService } = require('./kissvk-lightweight.service');
const axios = require('axios');

class AutoMusicSystemService {
  constructor() {
    this.kissVKService = getKissVKService();
    
    // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –¥–∞–Ω–Ω—ã—Ö
    // –í–ê–ñ–ù–û: –í—Å–µ —Ñ–∞–π–ª—ã —Å–∫–∞—á–∏–≤–∞—é—Ç—Å—è –¢–û–õ–¨–ö–û —Å KissVK!
    // –î—Ä—É–≥–∏–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—é—Ç —Ç–æ–ª—å–∫–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö —Ç—Ä–µ–∫–∞—Ö
    this.sources = {
      russian: {
        enabled: true,
        platforms: ['yandex'], // –¢–æ–ª—å–∫–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö —Ç—Ä–µ–∫–∞—Ö
        weight: 0.5
      },
      foreign: {
        enabled: true,
        platforms: ['billboard', 'itunes'], // –¢–æ–ª—å–∫–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö —Ç—Ä–µ–∫–∞—Ö
        weight: 0.5
      }
    };

    // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–∞–±–æ—Ç—ã —Å–∏—Å—Ç–µ–º—ã
    this.stats = {
      tracksImported: 0,
      playlistsCreated: 0,
      recommendationsGenerated: 0,
      lastUpdate: null
    };
  }

  /**
   * üöÄ –ì–õ–ê–í–ù–´–ô –ú–ï–¢–û–î: –ü–æ–ª–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã
   */
  async runFullUpdate() {
    console.log('\n' + '='.repeat(80));
    console.log('ü§ñ –ó–ê–ü–£–°–ö –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–û–ô –ú–£–ó–´–ö–ê–õ–¨–ù–û–ô –°–ò–°–¢–ï–ú–´');
    console.log('='.repeat(80));

    const startTime = Date.now();
    const results = {
      imports: {},
      playlists: {},
      recommendations: {},
      errors: []
    };

    try {
      // 1. –ò–º–ø–æ—Ä—Ç –Ω–æ–≤—ã—Ö —Ç—Ä–µ–∫–æ–≤ —Å –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö –ø–ª–æ—â–∞–¥–æ–∫
      console.log('\nüì• –≠–¢–ê–ü 1: –ò–º–ø–æ—Ä—Ç –Ω–æ–≤—ã—Ö —Ç—Ä–µ–∫–æ–≤');
      results.imports = await this.importPopularTracks();

      // 2. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–∞—Ä—Ç–æ–≤—ã—Ö –ø–ª–µ–π–ª–∏—Å—Ç–æ–≤
      console.log('\nüìä –≠–¢–ê–ü 2: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–∞—Ä—Ç–æ–≤—ã—Ö –ø–ª–µ–π–ª–∏—Å—Ç–æ–≤');
      results.playlists = await this.updateChartPlaylists();

      // 3. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π
      console.log('\nüéØ –≠–¢–ê–ü 3: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π');
      results.recommendations = await this.generatePersonalPlaylists();

      // 4. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
      this.stats.lastUpdate = new Date();
      
      const duration = ((Date.now() - startTime) / 1000).toFixed(2);
      console.log('\n' + '='.repeat(80));
      console.log(`‚úÖ –°–ò–°–¢–ï–ú–ê –£–°–ü–ï–®–ù–û –û–ë–ù–û–í–õ–ï–ù–ê –ó–ê ${duration}—Å`);
      console.log('='.repeat(80));

      return { success: true, results, duration };

    } catch (error) {
      console.error('\n‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê:', error);
      results.errors.push(error.message);
      return { success: false, results, error: error.message };
    }
  }

  /**
   * üì• –ò–º–ø–æ—Ä—Ç –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö —Ç—Ä–µ–∫–æ–≤ —Å–æ –≤—Å–µ—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
   */
  async importPopularTracks() {
    const results = {
      russian: { imported: 0, failed: 0 },
      foreign: { imported: 0, failed: 0 },
      total: 0
    };

    // –†–û–°–°–ò–ô–°–ö–ò–ï –ò–°–¢–û–ß–ù–ò–ö–ò
    if (this.sources.russian.enabled) {
      console.log('\nüá∑üá∫ –ò–º–ø–æ—Ä—Ç —Ä–æ—Å—Å–∏–π—Å–∫–∏—Ö —Ö–∏—Ç–æ–≤...');
      
      // 1. KissVK - –ø–æ–ø—É–ª—è—Ä–Ω—ã–µ —Ä–æ—Å—Å–∏–π—Å–∫–∏–µ —Ç—Ä–µ–∫–∏
      try {
        const kissVKResult = await this.importFromKissVK();
        results.russian.imported += kissVKResult.imported;
        results.russian.failed += kissVKResult.failed;
      } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ KissVK:', error.message);
        results.russian.failed++;
      }

      // 2. –Ø–Ω–¥–µ–∫—Å.–ú—É–∑—ã–∫–∞ —á–∞—Ä—Ç—ã (—ç–º—É–ª—è—Ü–∏—è)
      try {
        const yandexResult = await this.importFromYandexCharts();
        results.russian.imported += yandexResult.imported;
        results.russian.failed += yandexResult.failed;
      } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ –Ø–Ω–¥–µ–∫—Å.–ú—É–∑—ã–∫–∞:', error.message);
        results.russian.failed++;
      }
    }

    // –ó–ê–†–£–ë–ï–ñ–ù–´–ï –ò–°–¢–û–ß–ù–ò–ö–ò
    if (this.sources.foreign.enabled) {
      console.log('\nüåç –ò–º–ø–æ—Ä—Ç –∑–∞—Ä—É–±–µ–∂–Ω—ã—Ö —Ö–∏—Ç–æ–≤...');
      
      // 1. iTunes Top Charts
      try {
        const itunesResult = await this.importFromITunesCharts();
        results.foreign.imported += itunesResult.imported;
        results.foreign.failed += itunesResult.failed;
      } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ iTunes:', error.message);
        results.foreign.failed++;
      }

      // 2. Billboard Hot 100 (—ç–º—É–ª—è—Ü–∏—è)
      try {
        const billboardResult = await this.importFromBillboard();
        results.foreign.imported += billboardResult.imported;
        results.foreign.failed += billboardResult.failed;
      } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ Billboard:', error.message);
        results.foreign.failed++;
      }
    }

    results.total = results.russian.imported + results.foreign.imported;
    
    console.log(`\n‚úÖ –ò–º–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à–µ–Ω:`);
    console.log(`   üá∑üá∫ –†–æ—Å—Å–∏–π—Å–∫–∏—Ö: ${results.russian.imported}`);
    console.log(`   üåç –ó–∞—Ä—É–±–µ–∂–Ω—ã—Ö: ${results.foreign.imported}`);
    console.log(`   üìä –í—Å–µ–≥–æ: ${results.total}`);

    this.stats.tracksImported += results.total;
    return results;
  }

  /**
   * üíã –ò–º–ø–æ—Ä—Ç –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö —Ç—Ä–µ–∫–æ–≤ —Å KissVK
   */
  async importFromKissVK() {
    console.log('üíã –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö —Ç—Ä–µ–∫–æ–≤ KissVK...');
    
    const categories = [
      { url: 'https://kissvk.top/charts/top-100', name: 'Top 100', limit: 50 },
      { url: 'https://kissvk.top/charts/russian', name: '–†—É—Å—Å–∫–∞—è –º—É–∑—ã–∫–∞', limit: 30 },
      { url: 'https://kissvk.top/new', name: '–ù–æ–≤–∏–Ω–∫–∏', limit: 20 }
    ];

    let imported = 0;
    let failed = 0;

    for (const category of categories) {
      try {
        console.log(`   üìä ${category.name}...`);
        
        const result = await this.kissVKService.extractTracks(category.url, category.limit);
        
        if (result.tracks && result.tracks.length > 0) {
          // –†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ —Ç—Ä–µ–∫–æ–≤
          const decryptedTracks = await this.kissVKService.decryptTracks(result.tracks);
          
          // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î
          for (const trackData of decryptedTracks) {
            try {
              await this.saveTrackToDB(trackData, 'kissvk', category.name);
              imported++;
            } catch (error) {
              console.error(`      ‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç—Ä–µ–∫–∞: ${error.message}`);
              failed++;
            }
          }
        }
      } catch (error) {
        console.error(`   ‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ ${category.name}:`, error.message);
        failed++;
      }
    }

    console.log(`   ‚úÖ KissVK: –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ ${imported}, –æ—à–∏–±–æ–∫ ${failed}`);
    return { imported, failed };
  }

  /**
   * üéµ –ò–º–ø–æ—Ä—Ç –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö —Ç—Ä–µ–∫–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö –Ø–Ω–¥–µ–∫—Å.–ú—É–∑—ã–∫–∞
   * –í–ê–ñ–ù–û: –§–∞–π–ª—ã —Å–∫–∞—á–∏–≤–∞—é—Ç—Å—è –¢–û–õ–¨–ö–û —Å KissVK, –Ø–Ω–¥–µ–∫—Å –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç —Ç–æ–ª—å–∫–æ —Å–ø–∏—Å–æ–∫ –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö —Ç—Ä–µ–∫–æ–≤
   */
  async importFromYandexCharts() {
    console.log('üéµ –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö —Ç—Ä–µ–∫–∞—Ö —Å –Ø–Ω–¥–µ–∫—Å.–ú—É–∑—ã–∫–∞...');
    console.log('   üì• –°–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤: KissVK');
    
    // –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ —Ä–æ—Å—Å–∏–π—Å–∫–∏–µ —Ç—Ä–µ–∫–∏ 2025 (–¥–∞–Ω–Ω—ã–µ —Å –Ø–Ω–¥–µ–∫—Å.–ú—É–∑—ã–∫–∞ —á–∞—Ä—Ç–æ–≤)
    const popularRussianTracks = [
      { artist: '–ò–Ω—Å—Ç–∞—Å–∞–º–∫–∞', title: '–ó–∞ –¥–µ–Ω—å–≥–∏ –¥–∞', genre: '–†—É—Å—Å–∫–∏–π —Ä—ç–ø' },
      { artist: 'Miyagi & Andy Panda', title: 'Kosandra', genre: '–†—É—Å—Å–∫–∏–π —Ä—ç–ø' },
      { artist: '–°–∫—Ä–∏–ø—Ç–æ–Ω–∏—Ç', title: '–ü–æ–ª–æ–∂–µ–Ω–∏–µ', genre: '–†—É—Å—Å–∫–∏–π —Ä—ç–ø' },
      { artist: '–¢—Ä–∏ –¥–Ω—è –¥–æ–∂–¥—è', title: '–î–µ–º–æ–Ω—ã', genre: '–†—É—Å—Å–∫–∏–π —Ä–æ–∫' },
      { artist: 'Cream Soda', title: '–ù–∏–∫–∞–∫–∏—Ö –±–æ–ª—å—à–µ –≤–µ—á–µ—Ä–∏–Ω–æ–∫', genre: '–†—É—Å—Å–∫–∏–π –ø–æ–ø' },
      { artist: 'Big Baby Tape', title: 'Gimme The Loot', genre: '–†—É—Å—Å–∫–∏–π —Ä—ç–ø' },
      { artist: '–ú–æ–Ω–µ—Ç–æ—á–∫–∞', title: '–ö–∞–∂–¥—ã–π —Ä–∞–∑', genre: '–†—É—Å—Å–∫–∏–π –ø–æ–ø' },
      { artist: '–í–∞–ª–µ–Ω—Ç–∏–Ω –°—Ç—Ä—ã–∫–∞–ª–æ', title: '–ù–∞—à–µ –ª–µ—Ç–æ', genre: '–†—É—Å—Å–∫–∏–π –∏–Ω–¥–∏' },
      { artist: 'Oxxxymiron', title: '–ì–æ—Ä–æ–¥ –ø–æ–¥ –ø–æ–¥–æ—à–≤–æ–π', genre: '–†—É—Å—Å–∫–∏–π —Ä—ç–ø' },
      { artist: '–ö–æ—Ä–æ–ª—å –∏ –®—É—Ç', title: '–ö—É–∫–ª–∞ –∫–æ–ª–¥—É–Ω–∞', genre: '–†—É—Å—Å–∫–∏–π —Ä–æ–∫' },
      { artist: '–ú–∞–∫—Å –ö–æ—Ä–∂', title: '–ú–∞–ª—ã–π –ø–æ–≤–∑—Ä–æ—Å–ª–µ–ª', genre: '–†—É—Å—Å–∫–∏–π —Ä—ç–ø' },
      { artist: 'ANNA ASTI', title: '–ü–æ –±–∞—Ä–∞–º', genre: '–†—É—Å—Å–∫–∏–π –ø–æ–ø' },
      { artist: '–î–∂–∏–æ—Å', title: '–ú–∞–ª–∏–Ω–æ–≤—ã–π –∑–∞–∫–∞—Ç', genre: '–†—É—Å—Å–∫–∏–π –ø–æ–ø' },
      { artist: 'Danya Milokhin', title: '–ú–∞–ª–æ–ª–µ—Ç–∫–∞', genre: '–†—É—Å—Å–∫–∏–π –ø–æ–ø' }
    ];

    let imported = 0;
    let failed = 0;

    for (const trackInfo of popularRussianTracks) {
      try {
        // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç—Ä–µ–∫–µ –ø–æ–ª—É—á–µ–Ω–∞ —Å –Ø–Ω–¥–µ–∫—Å.–ú—É–∑—ã–∫–∞
        // –°–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª –¢–û–õ–¨–ö–û —Å KissVK
        const searchQuery = `${trackInfo.artist} ${trackInfo.title}`;
        const searchUrl = `https://kissvk.top/search?q=${encodeURIComponent(searchQuery)}`;
        
        console.log(`      üîç –ü–æ–∏—Å–∫ –Ω–∞ KissVK: ${trackInfo.artist} - ${trackInfo.title}`);
        const result = await this.kissVKService.extractTracks(searchUrl, 1);
        
        if (result.tracks && result.tracks.length > 0) {
          const decrypted = await this.kissVKService.decryptTracks(result.tracks);
          if (decrypted.length > 0) {
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å –∏—Å—Ç–æ—á–Ω–∏–∫–æ–º 'yandex' (–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è) + 'kissvk' (—Ñ–∞–π–ª)
            await this.saveTrackToDB(
              { ...decrypted[0], genre: trackInfo.genre }, 
              'yandex-chart', 
              '–Ø–Ω–¥–µ–∫—Å.–ú—É–∑—ã–∫–∞ –ß–∞—Ä—Ç'
            );
            imported++;
          }–ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö —Ç—Ä–µ–∫–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö iTunes Top Charts
   * –í–ê–ñ–ù–û: –§–∞–π–ª—ã —Å–∫–∞—á–∏–≤–∞—é—Ç—Å—è –¢–û–õ–¨–ö–û —Å KissVK, iTunes –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç —Ç–æ–ª—å–∫–æ —Å–ø–∏—Å–æ–∫ –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö —Ç—Ä–µ–∫–æ–≤
   */
  async importFromITunesCharts() {
    console.log('üçé –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö —Ç—Ä–µ–∫–∞—Ö —Å iTunes...');
    console.log('   üì• –°–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤: KissVK');
    
    let imported = 0;
    let failed = 0;

    try {
      // iTunes API - Top 25 Songs (—Ç–æ–ª—å–∫–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö —Ç—Ä–µ–∫–∞—Ö)
      const response = await axios.get('https://itunes.apple.com/us/rss/topsongs/limit=25/json', {
        timeout: 15000
      });

      const songs = response.data?.feed?.entry || [];
      console.log(`   üìä –ü–æ–ª—É—á–µ–Ω–æ —Ç—Ä–µ–∫–æ–≤ –∏–∑ iTunes: ${songs.length}`);

      for (const song of songs) {
        try {
          const trackInfo = {
            artist: song['im:artist']?.label || 'Unknown Artist',
            title: song['im:name']?.label || 'Unknown Title',
            genre: song.category?.attributes?.label || 'Pop',
            coverUrl: song['im:image']?.[2]?.label || null
          };

          // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç—Ä–µ–∫–µ –ø–æ–ª—É—á–µ–Ω–∞ —Å iTunes
          // –°–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª –¢–û–õ–¨–ö–û —Å KissVK
          const searchQuery = `${trackInfo.artist} ${trackInfo.title}`;
          const searchUrl = `https://kissvk.top/search?q=${encodeURIComponent(searchQuery)}`;
          
          console.log(`      üîç –ü–æ–∏—Å–∫ –Ω–∞ KissVK: ${trackInfo.artist} - ${trackInfo.title}`);
          const result = await this.kissVKService.extractTracks(searchUrl, 1);
          
          if (result.tracks && result.tracks.length > 0) {
            const decrypted = await this.kissVKService.decryptTracks(result.tracks);
            if (decrypted.length > 0) {
              // –û–±—ä–µ–¥–∏–Ω—è–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ iTunes –∏ —Ñ–∞–π–ª KissVK
              const trackData = { 
                ...decrypted[0],
                genre: trackInfo.genre,
                coverUrl: trackInfo.coverUrl || decrypted[0].coverUrl
              };
              await this.saveTrackToDB(trackData, 'itunes-chart', 'iTunes Top Chart');
              imported++;
            }
          } else {
            console.log(`      ‚ö†Ô∏è –ù–µ –Ω–∞–π–¥–µ–Ω –Ω–∞ KissVK: ${trackInfo.artist} - ${trackInfo.title}`);
            failed++;
          }
        } catch (error) {
          console.error(`      ‚ùå –û—à–∏–±–∫–∞: ${error.message}`);
          failed++;
        }–ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö —Ç—Ä–µ–∫–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö Billboard Hot 100
   * –í–ê–ñ–ù–û: –§–∞–π–ª—ã —Å–∫–∞—á–∏–≤–∞—é—Ç—Å—è –¢–û–õ–¨–ö–û —Å KissVK, Billboard –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç —Ç–æ–ª—å–∫–æ —Å–ø–∏—Å–æ–∫ –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö —Ç—Ä–µ–∫–æ–≤
   */
  async importFromBillboard() {
    console.log('üìä –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö —Ç—Ä–µ–∫–∞—Ö —Å Billboard...');
    console.log('   üì• –°–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤: KissVK');
    
    // –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –∑–∞—Ä—É–±–µ–∂–Ω—ã–µ —Ç—Ä–µ–∫–∏ 2025 (–¥–∞–Ω–Ω—ã–µ —Å Billboard Hot 100)
    const billboardTracks = [
      { artist: 'Taylor Swift', title: 'Fortnight', genre: 'Pop' },
      { artist: 'Sabrina Carpenter', title: 'Espresso', genre: 'Pop' },
      { artist: 'Billie Eilish', title: 'Lunch', genre: 'Alternative' },
      { artist: 'Ariana Grande', title: 'yes, and?', genre: 'Pop' },
      { artist: 'Post Malone & Morgan Wallen', title: 'I Had Some Help', genre: 'Country Pop' },
      { artist: 'Beyonc√©', title: 'Texas Hold Em', genre: 'Country' },
      { artist: 'Dua Lipa', title: 'Houdini', genre: 'Dance Pop' },
      { artist: 'The Weeknd', title: 'Timeless', genre: 'R&B' },
      { artist: 'Olivia Rodrigo', title: 'vampire', genre: 'Pop Rock' },
      { artist: 'Travis Scott', title: 'FE!N', genre: 'Hip Hop' },
      { artist: 'Charli XCX', title: '360', genre: 'Pop' },
      { artist: 'Chappell Roan', title: 'Good Luck, Babe!', genre: 'Pop' },
      { artist: 'Tate McRae', title: 'greedy', genre: 'Pop' },
      { artist: 'Teddy Swims', title: 'Lose Control', genre: 'R&B' }
    ];

    let imported = 0;
    let failed = 0;

    for (const trackInfo of billboardTracks) {
      try {
        // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç—Ä–µ–∫–µ –ø–æ–ª—É—á–µ–Ω–∞ —Å Billboard
        // –°–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª –¢–û–õ–¨–ö–û —Å KissVK
        const searchQuery = `${trackInfo.artist} ${trackInfo.title}`;
        const searchUrl = `https://kissvk.top/search?q=${encodeURIComponent(searchQuery)}`;
        
        console.log(`      üîç –ü–æ–∏—Å–∫ –Ω–∞ KissVK: ${trackInfo.artist} - ${trackInfo.title}`);
        const result = await this.kissVKService.extractTracks(searchUrl, 1);
        
        if (result.tracks && result.tracks.length > 0) {
          const decrypted = await this.kissVKService.decryptTracks(result.tracks);
          if (decrypted.length > 0) {
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å –∏—Å—Ç–æ—á–Ω–∏–∫–æ–º 'billboard' (–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è) + 'kissvk' (—Ñ–∞–π–ª)
            await this.saveTrackToDB(
              { ...decrypted[0], genre: trackInfo.genre }, 
              'billboard-chart', 
              'Billboard Hot 100'
            );
            imported++;
          }
        } else {
          console.log(`      ‚ö†Ô∏è –ù–µ –Ω–∞–π–¥–µ–Ω –Ω–∞ KissVK: ${trackInfo.artist} - ${trackInfo.title}`);
          failed++;
        }
      } catch (error) {
        console.error(`      ‚ùå –û—à–∏–±–∫–∞: ${trackInfo.artist} - ${trackInfo.title} - ${error.message}`);
        failed++;
      }
    }

    console.log(`   ‚úÖ Billboard ‚Üí KissVK: ${imported} —Ç—Ä–µ–∫–æ–≤, ${failed} –æ—à–∏–±–æ–∫
      { artist: 'Olivia Rodrigo', title: 'vampire', genre: 'Pop Rock' },
      { artist: 'Travis Scott', title: 'FE!N', genre: 'Hip Hop' }
    ];

    let imported = 0;
    let failed = 0;

    for (const trackInfo of billboardTracks) {
      try {
        const searchQuery = `${trackInfo.artist} ${trackInfo.title}`;
        const searchUrl = `https://kissvk.top/search?q=${encodeURIComponent(searchQuery)}`;
        
        const result = await this.kissVKService.extractTracks(searchUrl, 1);
        
        if (result.tracks && result.tracks.length > 0) {
          const decrypted = await this.kissVKService.decryptTracks(result.tracks);
          if (decrypted.length > 0) {
            await this.saveTrackToDB(decrypted[0], 'billboard-kissvk', 'Billboard Hot 100');
            imported++;
          }
        }
      } catch (error) {
        console.error(`   ‚ùå –û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ ${trackInfo.artist} - ${trackInfo.title}`);
        failed++;
      }
    }

    console.log(`   ‚úÖ Billboard: –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ ${imported}, –æ—à–∏–±–æ–∫ ${failed}`);
    return { imported, failed };
  }

  /**
   * üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç—Ä–µ–∫–∞ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
   */
  async saveTrackToDB(trackData, source, category) {
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –¥—É–±–ª–∏–∫–∞—Ç—ã
    const existing = await Track.findOne({
      where: {
        [Op.or]: [
          { fileUrl: trackData.url },
          {
            [Op.and]: [
              { artist: trackData.artist || 'Unknown' },
              { title: trackData.title || 'Unknown' }
            ]
          }
        ]
      }
    });

    if (existing) {
      // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ —Ç—Ä–µ–∫–∞
      await existing.update({
        playCount: (existing.playCount || 0) + 1,
        popularity: Math.min((existing.popularity || 50) + 5, 100)
      });
      return existing;
    }

    // –°–æ–∑–¥–∞—ë–º –Ω–æ–≤—ã–π —Ç—Ä–µ–∫
    const track = await Track.create({
      title: trackData.title || 'Unknown Title',
      artist: trackData.artist || 'Unknown Artist',
      genre: trackData.genre || category,
      duration: trackData.duration || 180,
      fileUrl: trackData.url,
      streamUrl: trackData.url,
      source: source,
      provider: 'kissvk',
      coverUrl: trackData.coverUrl || null,
      popularity: 75, // –í—ã—Å–æ–∫–∞—è –Ω–∞—á–∞–ª—å–Ω–∞—è –ø–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç—å –¥–ª—è —á–∞—Ä—Ç–æ–≤—ã—Ö —Ç—Ä–µ–∫–æ–≤
      playCount: 10, // –ù–∞—á–∞–ª—å–Ω—ã–π —Å—á—ë—Ç—á–∏–∫ –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–π
      externalId: trackData.externalId || null,
      metadata: JSON.stringify({
        category: category,
        importDate: new Date(),
        source: source
      })
    });

    console.log(`      ‚úÖ –°–æ—Ö—Ä–∞–Ω—ë–Ω: ${track.artist} - ${track.title}`);
    return track;
  }

  /**
   * üìä –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–∞—Ä—Ç–æ–≤—ã—Ö –ø–ª–µ–π–ª–∏—Å—Ç–æ–≤
   */
  async updateChartPlaylists() {
    console.log('\nüìä –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–∞—Ä—Ç–æ–≤—ã—Ö –ø–ª–µ–π–ª–∏—Å—Ç–æ–≤...');

    const results = {
      updated: 0,
      created: 0,
      failed: 0
    };

    const playlistConfigs = [
      {
        name: 'üî• –¢–û–ü 100 –•–ò–¢–û–í',
        description: '–°–∞–º—ã–µ –ø–æ–ø—É–ª—è—Ä–Ω—ã–µ —Ç—Ä–µ–∫–∏ –≤ –º–∏—Ä–µ –∏ –†–æ—Å—Å–∏–∏',
        type: 'chart',
        criteria: { limit: 100, sortBy: 'popularity' }
      },
      {
        name: 'üá∑üá∫ –†–£–°–°–ö–ò–ï –•–ò–¢–´ 2025',
        description: '–õ—É—á—à–∏–µ —Ä–æ—Å—Å–∏–π—Å–∫–∏–µ —Ç—Ä–µ–∫–∏ –≥–æ–¥–∞',
        type: 'chart',
        criteria: { limit: 50, genre: 'russian', sortBy: 'popularity' }
      },
      {
        name: 'üåç –ú–ò–†–û–í–´–ï –•–ò–¢–´ 2025',
        description: '–¢–æ–ø–æ–≤—ã–µ –∑–∞—Ä—É–±–µ–∂–Ω—ã–µ —Ç—Ä–µ–∫–∏ –≥–æ–¥–∞',
        type: 'chart',
        criteria: { limit: 50, genre: 'foreign', sortBy: 'popularity' }
      },
      {
        name: 'üÜï –ù–û–í–ò–ù–ö–ò –ù–ï–î–ï–õ–ò',
        description: '–°–≤–µ–∂–∏–µ —Ç—Ä–µ–∫–∏ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 7 –¥–Ω–µ–π',
        type: 'new',
        criteria: { limit: 30, daysAgo: 7, sortBy: 'createdAt' }
      },
      {
        name: 'üéß –†–ï–î–ê–ö–¢–û–†–°–ö–ò–ô –í–´–ë–û–†',
        description: '–õ—É—á—à–∞—è –º—É–∑—ã–∫–∞ –ø–æ –º–Ω–µ–Ω–∏—é –Ω–∞—à–µ–π –∫–æ–º–∞–Ω–¥—ã',
        type: 'editorial',
        criteria: { limit: 40, minPopularity: 80 }
      }
    ];

    for (const config of playlistConfigs) {
      try {
        const playlist = await this.createOrUpdatePlaylist(config);
        
        if (playlist.created) {
          results.created++;
        } else {
          results.updated++;
        }

        console.log(`   ‚úÖ ${config.name}: ${playlist.trackCount} —Ç—Ä–µ–∫–æ–≤`);
      } catch (error) {
        console.error(`   ‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è ${config.name}:`, error.message);
        results.failed++;
      }
    }

    console.log(`\n‚úÖ –ü–ª–µ–π–ª–∏—Å—Ç—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã:`);
    console.log(`   üìù –°–æ–∑–¥–∞–Ω–æ: ${results.created}`);
    console.log(`   üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–æ: ${results.updated}`);
    console.log(`   ‚ùå –û—à–∏–±–æ–∫: ${results.failed}`);

    this.stats.playlistsCreated += results.created + results.updated;
    return results;
  }

  /**
   * üìù –°–æ–∑–¥–∞–Ω–∏–µ/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–ª–µ–π–ª–∏—Å—Ç–∞
   */
  async createOrUpdatePlaylist(config) {
    // –ü–æ–∏—Å–∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø–ª–µ–π–ª–∏—Å—Ç–∞
    let playlist = await Playlist.findOne({
      where: { name: config.name }
    });

    let created = false;

    if (!playlist) {
      // –°–æ–∑–¥–∞—ë–º –Ω–æ–≤—ã–π –ø–ª–µ–π–ª–∏—Å—Ç
      playlist = await Playlist.create({
        name: config.name,
        description: config.description,
        type: config.type,
        isPublic: true,
        metadata: JSON.stringify({
          autoGenerated: true,
          criteria: config.criteria,
          lastUpdate: new Date()
        })
      });
      created = true;
    }

    // –ü–æ–ª—É—á–∞–µ–º —Ç—Ä–µ–∫–∏ –ø–æ –∫—Ä–∏—Ç–µ—Ä–∏—è–º
    const tracks = await this.getTracksByCriteria(config.criteria);

    // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ —Ç—Ä–µ–∫–∏ –∏–∑ –ø–ª–µ–π–ª–∏—Å—Ç–∞
    await PlaylistTrack.destroy({
      where: { playlistId: playlist.id }
    });

    // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ —Ç—Ä–µ–∫–∏
    for (let i = 0; i < tracks.length; i++) {
      await PlaylistTrack.create({
        playlistId: playlist.id,
        trackId: tracks[i].id,
        position: i + 1
      });
    }

    // –û–±–Ω–æ–≤–ª—è–µ–º –æ–±–ª–æ–∂–∫—É –ø–ª–µ–π–ª–∏—Å—Ç–∞ (–±–µ—Ä—ë–º –æ–±–ª–æ–∂–∫—É –ø–µ—Ä–≤–æ–≥–æ —Ç—Ä–µ–∫–∞)
    if (tracks.length > 0 && tracks[0].coverUrl) {
      await playlist.update({
        coverPath: tracks[0].coverUrl
      });
    }

    return { created, trackCount: tracks.length };
  }

  /**
   * üîç –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç—Ä–µ–∫–æ–≤ –ø–æ –∫—Ä–∏—Ç–µ—Ä–∏—è–º
   */
  async getTracksByCriteria(criteria) {
    const whereClause = {};
    const order = [];

    // –§–∏–ª—å—Ç—Ä –ø–æ –¥–∞—Ç–µ
    if (criteria.daysAgo) {
      const dateLimit = new Date();
      dateLimit.setDate(dateLimit.getDate() - criteria.daysAgo);
      whereClause.createdAt = { [Op.gte]: dateLimit };
    }

    // –§–∏–ª—å—Ç—Ä –ø–æ –ø–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç–∏
    if (criteria.minPopularity) {
      whereClause.popularity = { [Op.gte]: criteria.minPopularity };
    }

    // –§–∏–ª—å—Ç—Ä –ø–æ –∂–∞–Ω—Ä—É/—Ä–µ–≥–∏–æ–Ω—É
    if (criteria.genre === 'russian') {
      whereClause[Op.or] = [
        { genre: { [Op.like]: '%—Ä—É—Å—Å–∫%' } },
        { source: { [Op.like]: '%yandex%' } },
        { metadata: { [Op.like]: '%russian%' } }
      ];
    } else if (criteria.genre === 'foreign') {
      whereClause[Op.and] = [
        { genre: { [Op.notLike]: '%—Ä—É—Å—Å–∫%' } },
        { source: { [Op.notLike]: '%yandex%' } }
      ];
    }

    // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
    if (criteria.sortBy === 'popularity') {
      order.push(['popularity', 'DESC']);
      order.push(['playCount', 'DESC']);
    } else if (criteria.sortBy === 'createdAt') {
      order.push(['createdAt', 'DESC']);
    }

    // –ó–∞–ø—Ä–æ—Å
    const tracks = await Track.findAll({
      where: whereClause,
      order: order,
      limit: criteria.limit || 50
    });

    return tracks;
  }

  /**
   * üéØ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –ø–ª–µ–π–ª–∏—Å—Ç–æ–≤ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
   */
  async generatePersonalPlaylists() {
    console.log('\nüéØ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π...');

    const results = {
      usersProcessed: 0,
      playlistsGenerated: 0,
      failed: 0
    };

    // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –ª–∞–π–∫–∞–º–∏
    const users = await User.findAll({
      include: [{
        model: TrackLike,
        as: 'likedTracks',
        required: true
      }],
      group: ['User.id'],
      having: literal('COUNT(likedTracks.id) >= 5') // –ú–∏–Ω–∏–º—É–º 5 –ª–∞–π–∫–æ–≤
    });

    console.log(`   üë• –ù–∞–π–¥–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: ${users.length}`);

    for (const user of users) {
      try {
        await this.generatePersonalPlaylistForUser(user.id);
        results.usersProcessed++;
        results.playlistsGenerated++;
      } catch (error) {
        console.error(`   ‚ùå –û—à–∏–±–∫–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${user.id}:`, error.message);
        results.failed++;
      }
    }

    console.log(`\n‚úÖ –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –ø–ª–µ–π–ª–∏—Å—Ç—ã —Å–æ–∑–¥–∞–Ω—ã:`);
    console.log(`   üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ: ${results.usersProcessed}`);
    console.log(`   üìù –ü–ª–µ–π–ª–∏—Å—Ç–æ–≤ —Å–æ–∑–¥–∞–Ω–æ: ${results.playlistsGenerated}`);
    console.log(`   ‚ùå –û—à–∏–±–æ–∫: ${results.failed}`);

    this.stats.recommendationsGenerated += results.playlistsGenerated;
    return results;
  }

  /**
   * üë§ –°–æ–∑–¥–∞–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–≥–æ –ø–ª–µ–π–ª–∏—Å—Ç–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   */
  async generatePersonalPlaylistForUser(userId) {
    // 1. –ê–Ω–∞–ª–∏–∑ –ª–∞–π–∫–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const likedTracks = await Track.findAll({
      include: [{
        model: TrackLike,
        where: { userId },
        required: true
      }],
      limit: 100
    });

    if (likedTracks.length === 0) {
      return;
    }

    // 2. –ê–Ω–∞–ª–∏–∑ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π
    const preferences = this.analyzeUserPreferences(likedTracks);

    // 3. –ü–æ–¥–±–æ—Ä –ø–æ—Ö–æ–∂–∏—Ö —Ç—Ä–µ–∫–æ–≤
    const recommendations = await this.findSimilarTracks(preferences, 30);

    // 4. –°–æ–∑–¥–∞–Ω–∏–µ/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–ª–µ–π–ª–∏—Å—Ç–∞ "–ú–Ω–µ –ø–æ–Ω—Ä–∞–≤–∏—Ç—Å—è"
    let playlist = await Playlist.findOne({
      where: {
        userId: userId,
        name: '‚ù§Ô∏è –ú–ù–ï –ü–û–ù–†–ê–í–ò–¢–°–Ø'
      }
    });

    if (!playlist) {
      playlist = await Playlist.create({
        userId: userId,
        name: '‚ù§Ô∏è –ú–ù–ï –ü–û–ù–†–ê–í–ò–¢–°–Ø',
        description: '–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è –ø–æ–¥–±–æ—Ä–∫–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤–∞—à–∏—Ö –ª–∞–π–∫–æ–≤',
        type: 'personal',
        isPublic: false,
        metadata: JSON.stringify({
          autoGenerated: true,
          preferences: preferences,
          lastUpdate: new Date()
        })
      });
    }

    // 5. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç—Ä–µ–∫–æ–≤ –≤ –ø–ª–µ–π–ª–∏—Å—Ç–µ
    await PlaylistTrack.destroy({
      where: { playlistId: playlist.id }
    });

    for (let i = 0; i < recommendations.length; i++) {
      await PlaylistTrack.create({
        playlistId: playlist.id,
        trackId: recommendations[i].id,
        position: i + 1
      });
    }

    console.log(`      ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${userId}: ${recommendations.length} —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π`);
    return playlist;
  }

  /**
   * üìä –ê–Ω–∞–ª–∏–∑ –º—É–∑—ã–∫–∞–ª—å–Ω—ã—Ö –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   */
  analyzeUserPreferences(likedTracks) {
    const preferences = {
      genres: {},
      artists: {},
      avgPopularity: 0,
      totalTracks: likedTracks.length
    };

    let popularitySum = 0;

    for (const track of likedTracks) {
      // –ü–æ–¥—Å—á—ë—Ç –∂–∞–Ω—Ä–æ–≤
      if (track.genre) {
        preferences.genres[track.genre] = (preferences.genres[track.genre] || 0) + 1;
      }

      // –ü–æ–¥—Å—á—ë—Ç –∞—Ä—Ç–∏—Å—Ç–æ–≤
      if (track.artist) {
        preferences.artists[track.artist] = (preferences.artists[track.artist] || 0) + 1;
      }

      // –°—Ä–µ–¥–Ω—è—è –ø–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç—å
      popularitySum += track.popularity || 50;
    }

    preferences.avgPopularity = Math.round(popularitySum / likedTracks.length);

    // –¢–æ–ø-3 –∂–∞–Ω—Ä–∞
    preferences.topGenres = Object.entries(preferences.genres)
      .sort((a, b) => b[1] - a[1])
      .slice(0, 3)
      .map(([genre]) => genre);

    // –¢–æ–ø-5 –∞—Ä—Ç–∏—Å—Ç–æ–≤
    preferences.topArtists = Object.entries(preferences.artists)
      .sort((a, b) => b[1] - a[1])
      .slice(0, 5)
      .map(([artist]) => artist);

    return preferences;
  }

  /**
   * üîç –ü–æ–∏—Å–∫ –ø–æ—Ö–æ–∂–∏—Ö —Ç—Ä–µ–∫–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π
   */
  async findSimilarTracks(preferences, limit = 30) {
    const whereClause = {
      [Op.or]: []
    };

    // –ü–æ–∏—Å–∫ –ø–æ —Ç–æ–ø–æ–≤—ã–º –∂–∞–Ω—Ä–∞–º
    if (preferences.topGenres && preferences.topGenres.length > 0) {
      whereClause[Op.or].push({
        genre: { [Op.in]: preferences.topGenres }
      });
    }

    // –ü–æ–∏—Å–∫ –ø–æ —Ç–æ–ø–æ–≤—ã–º –∞—Ä—Ç–∏—Å—Ç–∞–º
    if (preferences.topArtists && preferences.topArtists.length > 0) {
      whereClause[Op.or].push({
        artist: { [Op.in]: preferences.topArtists }
      });
    }

    // –ü–æ–∏—Å–∫ –ø–æ –ø–æ—Ö–æ–∂–µ–π –ø–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç–∏ (¬±20 –æ—Ç —Å—Ä–µ–¥–Ω–µ–π)
    whereClause.popularity = {
      [Op.between]: [
        Math.max(0, preferences.avgPopularity - 20),
        Math.min(100, preferences.avgPopularity + 20)
      ]
    };

    // –ò—Å–∫–ª—é—á–∞–µ–º —É–∂–µ –ª–∞–π–∫–Ω—É—Ç—ã–µ —Ç—Ä–µ–∫–∏
    const likedTrackIds = await TrackLike.findAll({
      attributes: ['trackId'],
      raw: true
    }).then(likes => likes.map(l => l.trackId));

    if (likedTrackIds.length > 0) {
      whereClause.id = { [Op.notIn]: likedTrackIds };
    }

    // –ó–∞–ø—Ä–æ—Å
    const tracks = await Track.findAll({
      where: whereClause,
      order: [
        ['popularity', 'DESC'],
        ['playCount', 'DESC'],
        ['createdAt', 'DESC']
      ],
      limit: limit * 2 // –ë–µ—Ä—ë–º –±–æ–ª—å—à–µ –¥–ª—è —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏—è
    });

    // –î–∏–≤–µ—Ä—Å–∏—Ñ–∏–∫–∞—Ü–∏—è: –±–µ—Ä—ë–º –Ω–µ –ø–æ–¥—Ä—è–¥, –∞ —Å –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞–º–∏
    const diversified = [];
    for (let i = 0; i < tracks.length && diversified.length < limit; i += 2) {
      diversified.push(tracks[i]);
    }

    return diversified;
  }

  /**
   * üìä –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Å–∏—Å—Ç–µ–º—ã
   */
  getStats() {
    return {
      ...this.stats,
      uptime: this.stats.lastUpdate 
        ? Math.floor((Date.now() - this.stats.lastUpdate.getTime()) / 1000 / 60)
        : null
    };
  }

  /**
   * üîß –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
   */
  configureSources(config) {
    this.sources = { ...this.sources, ...config };
    console.log('‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –æ–±–Ω–æ–≤–ª–µ–Ω–∞');
  }
}

// –≠–∫—Å–ø–æ—Ä—Ç —Å–∏–Ω–≥–ª—Ç–æ–Ω–∞
let instance = null;

module.exports = {
  getInstance: () => {
    if (!instance) {
      instance = new AutoMusicSystemService();
    }
    return instance;
  },
  AutoMusicSystemService
};
