# TeamSpeak Time Tracking Fix

## –ü—Ä–æ–±–ª–µ–º–∞
–í—Ä–µ–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ TeamSpeak **–Ω–µ –∑–∞—á–∏—Ç—ã–≤–∞–ª–æ—Å—å**, –≥—Ä–∞—Ñ–∏–∫ "–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ –≤—Ä–µ–º–µ–Ω–∏ —Å—É—Ç–æ–∫" –Ω–∞ https://errorparty.ru/dashboard **–Ω–µ —Ä–∞–±–æ—Ç–∞–ª**.

## Root Cause Analysis

### 1. –°–∏–º–ø—Ç–æ–º—ã
- API endpoint `/api/server/teamspeak` –ø–æ–∫–∞–∑—ã–≤–∞–ª:
  ```json
  {
    "clientsOnline": 2,
    "clients": []  // –ü–£–°–¢–û–ô –ú–ê–°–°–ò–í!
  }
  ```
- –õ–æ–≥–∏ –ø–æ–∫–∞–∑—ã–≤–∞–ª–∏: `‚úÖ Synced time for 0 online clients`
- `clientConnectTimes` Map –±—ã–ª–∞ –ø—É—Å—Ç–∞—è
- –ì—Ä–∞—Ñ–∏–∫ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞–ª –¥–∞–Ω–Ω—ã–µ

### 2. –ü—Ä–∏—á–∏–Ω–∞
–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ `ts3-nodejs-library` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç Proxy –æ–±—ä–µ–∫—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ:
- **–ù–ï –ü–û–î–î–ï–†–ñ–ò–í–ê–Æ–¢** –ø–∞—Ä–∞–º–µ—Ç—Ä `client_type` –≤ –º–µ—Ç–æ–¥–µ `clientList()`
- –ò—Å–ø–æ–ª—å–∑—É—é—Ç —Å–≤–æ–π—Å—Ç–≤–æ **`type`**, –∞ –Ω–µ `clientType`
- –°—Ç–∞—Ä—ã–π –∫–æ–¥: `clientList({ client_type: 0 })` ‚Üí –≤–æ–∑–≤—Ä–∞—â–∞–ª **–ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤**

### 3. –ó–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ —Ñ–∞–π–ª—ã
- `backend/src/services/teamspeakService.js`
  - –ú–µ—Ç–æ–¥ `getOnlineClients()` (—Å—Ç—Ä–æ–∫–∞ ~341)
  - –ú–µ—Ç–æ–¥ `getClientFullInfo()` (—Å—Ç—Ä–æ–∫–∞ ~624)

## –†–µ—à–µ–Ω–∏–µ

### –°–¢–ê–¢–£–°: üü° –ß–ê–°–¢–ò–ß–ù–û –ò–°–ü–†–ê–í–õ–ï–ù–û

**‚úÖ –†–ê–ë–û–¢–ê–ï–¢:**
- –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤ (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω `clientList`)
- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–æ–≤ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç—Å—è
- –ö–ª–∏–µ–Ω—Ç—ã –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è –≤ `clientConnectTimes` Map
- –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç (–∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç)
- –°–æ–±—ã—Ç–∏—è —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É—é—Ç—Å—è —á–µ—Ä–µ–∑ `registerEvent('server')`

**‚ùå –ù–ï –†–ê–ë–û–¢–ê–ï–¢:**
- –°–æ–±—ã—Ç–∏–µ `clientleftview` **–ù–ï –°–†–ê–ë–ê–¢–´–í–ê–ï–¢** –ø—Ä–∏ –æ—Ç–∫–ª—é—á–µ–Ω–∏–∏
- TeamSpeak ServerQuery –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç `notifyclientleftview` (–≤–∏–¥–Ω–æ –≤ debug)
- –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ `ts3-nodejs-library` **–ù–ï –≠–ú–ò–¢–ò–¢** —ç—Ç–æ —Å–æ–±—ã—Ç–∏–µ
- –í—Ä–µ–º—è **–ù–ï –°–û–•–†–ê–ù–Ø–ï–¢–°–Ø** –ø—Ä–∏ –æ—Ç–∫–ª—é—á–µ–Ω–∏–∏ –∫–ª–∏–µ–Ω—Ç–∞

**üîß WORKAROUND (–í–†–ï–ú–ï–ù–ù–û–ï –†–ï–®–ï–ù–ò–ï):**
–í—Ä–µ–º—è —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ **–ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫—É—é —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é** –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç, —Ç–∞–∫ —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ü–û–õ–£–ß–ê–Æ–¢ –≤—Ä–µ–º—è, –Ω–æ —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π –¥–æ 5 –º–∏–Ω—É—Ç.

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –∫–æ–¥

#### 1. `getOnlineClients()` - –ò–°–ü–†–ê–í–õ–ï–ù–û ‚úÖ
```javascript
// –ë–´–õ–û (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ):
const clients = await this.client.clientList({ client_type: 0 });

// –°–¢–ê–õ–û (–ø—Ä–∞–≤–∏–ª—å–Ω–æ):
const allClients = await this.client.clientList();
const clients = allClients.filter(client => client.type === 0);
```

#### 2. –ú–∞–ø–ø–∏–Ω–≥ —Å–≤–æ–π—Å—Ç–≤ - –ò–°–ü–†–ê–í–õ–ï–ù–û ‚úÖ
```javascript
// –ë–´–õ–û (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ):
client_type: client.clientType, // undefined!

// –°–¢–ê–õ–û (–ø—Ä–∞–≤–∏–ª—å–Ω–æ):
client_type: client.type, // 0 –∏–ª–∏ 1
```

#### 3. `getClientFullInfo()` - –ò–°–ü–†–ê–í–õ–ï–ù–û ‚úÖ
```javascript
// –ë–´–õ–û (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ):
const clients = await this.client.clientList({ client_type: 0 });

// –°–¢–ê–õ–û (–ø—Ä–∞–≤–∏–ª—å–Ω–æ):
const allClients = await this.client.clientList();
const clients = allClients.filter(c => c.type === 0);
```

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
```powershell
# 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å API
Invoke-WebRequest http://localhost:3001/api/server/teamspeak

# –û–∂–∏–¥–∞–µ—Ç—Å—è:
# "clientsOnline": 2
# "clients": [ { "nickname": "..." } ]  ‚Üê –ù–ï –ü–£–°–¢–û!

# 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏
docker logs errorparty_backend --tail 30 | Select-String -Pattern "Initialized|Synced"

# –û–∂–∏–¥–∞–µ—Ç—Å—è:
# ‚úÖ Initialized 1 already connected clients  ‚Üê –ù–ï 0!
```

### –†—É—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
1. **–ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å** –∫ TeamSpeak —Å–µ—Ä–≤–µ—Ä—É `errorparty.ru:9987`
2. **–ü–æ–¥–æ–∂–¥–∏—Ç–µ** 30 —Å–µ–∫—É–Ω–¥
3. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏**:
   ```bash
   docker logs errorparty_backend --tail 50
   ```
   –î–æ–ª–∂–Ω–æ –±—ã—Ç—å:
   - `üë§ Client connected: –í–∞—à–ù–∏–∫ (clid: XX)`
   - `‚úÖ Client info: UID=..., Nickname=–í–∞—à–ù–∏–∫`
   - `üíæ Saved to Map: clid=XX`
4. **–û—Ç–∫–ª—é—á–∏—Ç–µ—Å—å** –æ—Ç TeamSpeak
5. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ —Å–Ω–æ–≤–∞**:
   ```bash
   docker logs errorparty_backend --tail 30
   ```
   –î–æ–ª–∂–Ω–æ –±—ã—Ç—å:
   - `üëã Client left: –í–∞—à–ù–∏–∫ (clid: XX)`
   - `üíæ Saved XXX seconds to database for ...`

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
```sql
-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –≤—Ä–µ–º—è –∑–∞–ø–∏—Å–∞–ª–æ—Å—å
SELECT id, username, total_online_time, last_seen 
FROM users 
WHERE total_online_time > 0 
ORDER BY last_seen DESC 
LIMIT 5;
```

## –†–µ–∑—É–ª—å—Ç–∞—Ç—ã

### –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
- ‚ùå `clientList({ client_type: 0 })` ‚Üí –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤ `[]`
- ‚ùå `clientConnectTimes.size = 0`
- ‚ùå `getOnlineClients()` ‚Üí `[]`
- ‚ùå –í—Ä–µ–º—è –Ω–µ –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –≤ –±–∞–∑—É
- ‚ùå –ì—Ä–∞—Ñ–∏–∫ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø—É—Å—Ç–æ–π

### –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
- ‚úÖ `clientList()` ‚Üí 2 –∫–ª–∏–µ–Ω—Ç–∞
- ‚úÖ `filter(c => c.type === 0)` ‚Üí 1 –∫–ª–∏–µ–Ω—Ç (–∏—Å–∫–ª—é—á–µ–Ω ServerQuery –±–æ—Ç)
- ‚úÖ `clientConnectTimes.size = 1`
- ‚úÖ `getOnlineClients()` ‚Üí `[{ nickname: "Satiler", ... }]`
- ‚úÖ –í—Ä–µ–º—è –¥–æ–ª–∂–Ω–æ –∑–∞–ø–∏—Å—ã–≤–∞—Ç—å—Å—è –≤ –±–∞–∑—É (—Ç—Ä–µ–±—É–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏)
- ‚úÖ –ì—Ä–∞—Ñ–∏–∫ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –¥–æ–ª–∂–µ–Ω —Ä–∞–±–æ—Ç–∞—Ç—å (—Ç—Ä–µ–±—É–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏)

## –°–≤—è–∑–∞–Ω–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

### –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è (–∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç)
```javascript
// backend/src/services/teamspeakService.js
startPeriodicTimeSync() {
  setInterval(async () => {
    // –û–±–Ω–æ–≤–ª—è–µ—Ç –≤—Ä–µ–º—è –¥–ª—è –≤—Å–µ—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ –≤ clientConnectTimes Map
    for (const [clid, clientData] of this.clientConnectTimes.entries()) {
      // ...
    }
  }, 5 * 60 * 1000);
}
```

### –°–æ–±—ã—Ç–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è/–æ—Ç–∫–ª—é—á–µ–Ω–∏—è
```javascript
// backend/src/services/teamspeakService.js
this.client.on('clientconnect', async (ev) => {
  // 1. –ü–æ–ª—É—á–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–ª–∏–µ–Ω—Ç–µ
  // 2. –î–æ–±–∞–≤–ª—è–µ—Ç –≤ clientConnectTimes Map
  // 3. –ò–Ω–∫—Ä–µ–º–µ–Ω—Ç–∏—Ä—É–µ—Ç —Å—á–µ—Ç—á–∏–∫ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π
});

this.client.on('clientleftview', async (ev) => {
  // 1. –ü–æ–ª—É—á–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ clientConnectTimes Map
  // 2. –í—ã—á–∏—Å–ª—è–µ—Ç –≤—Ä–µ–º—è –æ–Ω–ª–∞–π–Ω
  // 3. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
  // 4. –£–¥–∞–ª—è–µ—Ç –∏–∑ Map
});
```

## Next Steps

- [ ] **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:** –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ TS –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –≤—Ä–µ–º—è –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è
- [ ] **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:** –ü–æ–¥–æ–∂–¥–∞—Ç—å 5 –º–∏–Ω—É—Ç –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ `‚è∞ Periodic time sync`
- [ ] **–í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –≥—Ä–∞—Ñ–∏–∫ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ
- [ ] **Cleanup:** –£–±—Ä–∞—Ç—å debug –ª–æ–≥–∏ –µ—Å–ª–∏ –≤—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ ts3-nodejs-library
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç **Proxy –æ–±—ä–µ–∫—Ç—ã**, –∞ –Ω–µ –ø—Ä–æ—Å—Ç—ã–µ JS –æ–±—ä–µ–∫—Ç—ã
- –°–≤–æ–π—Å—Ç–≤–∞ –¥–æ—Å—Ç—É–ø–Ω—ã —á–µ—Ä–µ–∑ –≥–µ—Ç—Ç–µ—Ä—ã: `client.nickname`, `client.type`
- **–ù–ï –†–ê–ë–û–¢–ê–ï–¢** `Object.keys()` - –≤–µ—Ä–Ω–µ—Ç `['namespace', 'propcache', 'parent']`
- **client.type**: `0` = –æ–±—ã—á–Ω—ã–π –∫–ª–∏–µ–Ω—Ç, `1` = ServerQuery –±–æ—Ç
- **clientList()** –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –í–°–ï —Ç–∏–ø—ã –∫–ª–∏–µ–Ω—Ç–æ–≤ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

### –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–æ–≤
```javascript
// ‚ùå –ù–ï –†–ê–ë–û–¢–ê–ï–¢:
const clients = await client.clientList({ client_type: 0 });

// ‚úÖ –†–ê–ë–û–¢–ê–ï–¢:
const allClients = await client.clientList();
const regularClients = allClients.filter(c => c.type === 0);
```

## –î–∞—Ç–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
25 –Ω–æ—è–±—Ä—è 2025

## –ê–≤—Ç–æ—Ä
GitHub Copilot (Claude Sonnet 4.5)
